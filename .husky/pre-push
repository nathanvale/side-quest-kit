#!/usr/bin/env bash
set -euo pipefail

# Block direct pushes to protected branches. Use PRs instead.
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
  echo "Push to protected branch '$current_branch' is blocked."
  echo "Create a feature branch and open a PR."
  echo "Override (not recommended): ALLOW_PUSH_PROTECTED=1 git push"
  if [ "${ALLOW_PUSH_PROTECTED:-}" != "1" ]; then
    exit 1
  fi
fi

# Remind users to enable branch protection (one-time, non-blocking).
# Once verified, creates a marker file so it never checks again.
MARKER=".husky/.protection-verified"
if [ ! -f "$MARKER" ] && command -v gh >/dev/null 2>&1; then
  repo=$(gh repo view --json nameWithOwner --jq '.nameWithOwner' 2>/dev/null || true)
  if [ -n "$repo" ]; then
    if gh api "repos/$repo/branches/main/protection" >/dev/null 2>&1; then
      mkdir -p .husky
      touch "$MARKER"
    else
      echo ""
      echo "WARNING: Branch protection is not enabled on main."
      echo "Run 'bun run setup:protect' to enable it."
      echo ""
    fi
  fi
fi
